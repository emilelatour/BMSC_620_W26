---
title: "Power and Sample Size"
subtitle: "Textbook Section 5.4"
author: "Emile Latour, Nicky Wakim, Meike Niederhausen"
date: "`r library(here); source(here('class_dates.R')); w7d2`"
date-format: long
format:
  revealjs:
    theme: "../../assets/css/reveal-bmsc620_v5.scss"
    slide-number: true
    show-slide-number: all
    width: 1955
    height: 1100
    footer: "BMSC 620 | Power and Sample Size"
    html-math-method: mathjax
    chalkboard: true
execute:
  echo: true
  warning: false
  message: false
  freeze: auto
---

```{r}
#| label: setup
#| include: false

library(tidyverse)
library(broom)
library(glue)
library(here)
library(knitr)
library(oibiostat)
library(patchwork)
library(rstatix)
library(pwr)  # NEW package for power calculations

library(lamisc)
library(laviz)     

# Set theme for plots
theme_set(laviz::theme_minimal_white(grid = "none", 
                                     axis = "xy", 
                                     base_size = 16))

set.seed(456)
```

# Learning Objectives

By the end of today, you will be able to:

1. Define Type I error, Type II error, and power  
2. Explain how alpha, effect size, variability, and sample size are related  
3. Calculate required sample size using `pwr.t.test()`  
4. Interpret power in the context of a clinical trial  

---

# The Through-Line Example

## New Blood Pressure Drug

Research Question:  
Does a new drug reduce systolic blood pressure more than placebo?

Design:  
Two independent groups (randomized)

Primary endpoint:  
Change in systolic BP (mmHg)

---

# What must we decide before the trial?

- Significance level (alpha)
- Desired power
- Clinically meaningful difference (Delta)
- Expected variability (sigma)
- Sample size (n)

Key question:  
If the true reduction is 5 mmHg, how likely are we to detect it?

---

# The Four Components in Equilibrium

In any hypothesis test, four quantities are mathematically linked:

1. Significance level (alpha)  
2. Effect size (Delta or Cohen's d)  
3. Sample size (n)  
4. Power (1 - beta)

If you fix any three, the fourth is determined.

---

# Type I and Type II Errors

| Reality | H0 True | H0 False |
|----------|----------|-----------|
| Reject H0 | Type I error (alpha) | Power (1 - beta) |
| Fail to reject H0 | Correct (1 - alpha) | Type II error (beta) |

Power = Probability of detecting a real effect when it exists.

---

# Translating to Effect Size

Suppose:

- Clinically meaningful difference: Delta = 5 mmHg  
- Expected SD: sigma = 10 mmHg  

Cohen's d:

$$
d = \frac{\Delta}{\sigma}
$$

```{r}
delta <- 5
sigma <- 10

d <- delta / sigma
d
```

---

# Calculating Required Sample Size

We want:

- alpha = 0.05  
- power = 0.80  
- two independent groups  

```{r}
result <- pwr.t.test(
  d = d,
  sig.level = 0.05,
  power = 0.80,
  type = "two.sample",
  alternative = "two.sided"
)

result
```

Required sample size per group:

```{r}
ceiling(result$n)
```

---

# Sensitivity Analysis (Live Demo)

Change one assumption at a time:

- sigma = 12  
- power = 0.90  
- Delta = 3  
- alpha = 0.01  

Observe how required n changes.

---

# Why Does This Happen?

Required n follows this structure:

$$
n \propto 
\frac{(z_{\alpha/2} + z_{\beta})^2 \sigma^2}{\Delta^2}
$$

This tells us:

- Larger sigma -> larger n  
- Smaller Delta -> larger n  
- Higher power -> larger n  
- Smaller alpha -> larger n  

---

# Power Curve

```{r}
n_seq <- seq(20, 200, by = 5)

power_vals <- sapply(n_seq, function(n_val) {
  pwr.t.test(
    n = n_val,
    d = d,
    sig.level = 0.05,
    type = "two.sample"
  )$power
})

plot(n_seq, power_vals, type = "l",
     xlab = "Sample size per group",
     ylab = "Power",
     main = "Power increases with sample size")
```

---

# Practical Reality

Planned for n = 64 per group  
Recruited n = 50  
Actual SD = 12  

Observed difference = 4 mmHg  
p = 0.09  

Was the drug ineffective?  
Or was the study underpowered?

---

# Key Takeaways

1. Power = Probability of detecting a true effect  
2. Effect size and variability drive required sample size  
3. Power analysis should be done prospectively  
4. Sample size decisions are scientific and ethical  

---

# Key R Function

```r
pwr.t.test(
  n = NULL,
  d = NULL,
  sig.level = 0.05,
  power = NULL,
  type = "two.sample",
  alternative = "two.sided"
)
```

Leave out the parameter you want to calculate.
